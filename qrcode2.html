<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Aset SMPN 10 Banawa Selatan</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Material Icons for menu icon -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    body {
      padding-top: 60px;
    }
    @media (min-width: 768px) {
      body {
        padding-left: 16rem;
        padding-top: 20px;
      }
    }
    aside {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      z-index: 1030;
    }
    img.thumbnail {
      max-width: 100px;
      max-height: 100px;
      object-fit: cover;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

  <!-- Sidebar (Desktop) -->
  <aside class="w-64 bg-blue-800 text-white flex-shrink-0 hidden md:block">
    <div class="p-4 font-bold text-xl border-b border-blue-700">Inventaris SMPN 10</div>
    <nav class="p-4 space-y-2">
      <a href="ruangankantor.html" class="d-block text-white text-decoration-none hover:bg-blue-700 px-3 py-2 rounded">Ruangan Kantor</a>
      <a href="ruanganperpustakaan.html" class="d-block text-white text-decoration-none hover:bg-blue-700 px-3 py-2 rounded">Ruangan Perpustakaan</a>
      <a href="qrcode2.html" class="d-block text-white text-decoration-none hover:bg-blue-700 px-3 py-2 rounded">QR CODE</a>
    </nav>
  </aside>

  <!-- Mobile Navbar -->
  <header class="bg-blue-800 text-white w-100 fixed-top d-md-none z-3">
    <div class="d-flex justify-content-between align-items-center p-3">
      <h1 class="h5 m-0">Inventaris SMPN 10</h1>
      <button id="menu-btn" class="btn btn-sm text-white">
        <span class="material-icons">menu</span>
      </button>
    </div>
    <div id="dropdown" class="d-none px-3 pb-3 bg-blue-700">
      <a href="ruangankantor.html" class="d-block text-white text-decoration-none py-1">Ruangan Kantor</a>
      <a href="ruanganperpustakaan.html" class="d-block text-white text-decoration-none py-1">Ruangan Perpustakaan</a>
      <a href="qrcode2.html" class="d-block text-white text-decoration-none py-1">QR CODE</a>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <h2 class="mb-4">Data Aset Peralatan dan Mesin Dinas Pendidikan dan Kebudayaan</h2>

    <!-- Filter -->
    <div class="row mb-3">
      <div class="col-md-6 mb-2">
        <input type="text" id="searchInput" class="form-control" placeholder="Cari data...">
      </div>
      <div class="col-md-6 mb-2">
        <select id="kecamatanFilter" class="form-select">
          <option value="">Semua Kecamatan</option>
        </select>
      </div>
    </div>

    <!-- Tabel -->
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead id="tableHead" class="table-light"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <nav>
      <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
  </div>

  <!-- Modal Preview Grid -->
  <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewModalLabel">Preview Dokumen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3" id="previewContentRow"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Toggle Mobile Menu
    document.getElementById("menu-btn").addEventListener("click", () => {
      const dropdown = document.getElementById("dropdown");
      dropdown.classList.toggle("d-none");
    });

    const sheetID = "152oNQyrJEeg-xW3okB2LKbGIUapxDakDMCbDjqpDl3U";
    const sheetGID = "0";
    const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&gid=${sheetGID}`;

    let fullData = [], filteredData = [], headers = [], currentPage = 1;
    const rowsPerPage = 10;

    fetch(sheetURL)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substr(47).slice(0, -2));
        headers = json.table.cols.map(col => col.label);
        fullData = json.table.rows.map(row => row.c.map(cell => cell ? cell.v : ""));
        filteredData = [...fullData];
        renderTableHeader();
        renderFilterOptions();
        renderTable();
        renderPagination();
      });

    function renderTableHeader() {
      const thead = document.getElementById("tableHead");
      thead.innerHTML = "<tr>" + headers.map(h => `<th>${h}</th>`).join('') + "<th>Preview Semua</th></tr>";
    }

    function getFileTypeIcon(url) {
      const lower = url.toLowerCase();
      if (lower.includes(".pdf")) return { icon: "bi-file-earmark-pdf", color: "danger", label: "PDF" };
      if (lower.includes(".doc")) return { icon: "bi-file-earmark-word", color: "primary", label: "Word" };
      if (lower.includes(".xls")) return { icon: "bi-file-earmark-excel", color: "success", label: "Excel" };
      if (lower.includes(".jpg") || lower.includes(".png")) return { icon: "bi-file-earmark-image", color: "info", label: "Gambar" };
      return { icon: "bi-file-earmark", color: "secondary", label: "Dokumen" };
    }

    function extractDriveFileId(url) {
      const match = url.match(/[-\w]{25,}/);
      return match ? match[0] : "";
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pageData = filteredData.slice(start, end);

      pageData.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach((cell, i) => {
          const td = document.createElement("td");
          const header = headers[i].toLowerCase();
          const isDriveLink = typeof cell === "string" && cell.includes("drive.google.com");

          if (isDriveLink) {
            const fileId = extractDriveFileId(cell);
            const fileInfo = getFileTypeIcon(cell);
            const label = header.includes("kib") ? "ðŸ“‚ Dokumen KIB" : header.includes("barcode") ? "ðŸ§¾ Barcode" : headers[i];

            td.innerHTML = `
              <div class="d-flex flex-column align-items-start">
                <img src="https://drive.google.com/thumbnail?id=${fileId}" class="thumbnail rounded border mb-1" alt="${label}">
                <span class="badge bg-${fileInfo.color}" data-bs-toggle="tooltip" title="File ${fileInfo.label}">
                  <i class="bi ${fileInfo.icon}"></i> ${fileInfo.label}
                </span>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="openPreviewModalGrid([{label: '${label}', fileId: '${fileId}'}])">Preview</button>
                <a href="https://drive.google.com/uc?export=download&id=${fileId}" target="_blank" class="btn btn-sm btn-outline-secondary mt-1">Unduh <i class="bi bi-download"></i></a>
              </div>
            `;
          } else {
            td.textContent = cell;
          }

          tr.appendChild(td);
        });

        // Preview Semua
        const previewAllTd = document.createElement("td");
        const fileObjs = row.map((cell, i) => {
          const isDrive = typeof cell === "string" && cell.includes("drive.google.com");
          if (!isDrive) return null;
          return { fileId: extractDriveFileId(cell), label: headers[i] };
        }).filter(Boolean);

        previewAllTd.innerHTML = fileObjs.length
          ? `<button class="btn btn-sm btn-dark" onclick='openPreviewModalGrid(${JSON.stringify(fileObjs)})'>Preview Semua</button>`
          : "-";

        tr.appendChild(previewAllTd);
        tbody.appendChild(tr);
      });

      enableTooltips();
    }

    function enableTooltips() {
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement("li");
        li.className = `page-item ${i === currentPage ? "active" : ""}`;
        li.innerHTML = `<button class="page-link">${i}</button>`;
        li.addEventListener("click", () => {
          currentPage = i;
          renderTable();
          renderPagination();
        });
        pagination.appendChild(li);
      }
    }

    function applyFilters() {
      const searchValue = document.getElementById("searchInput").value.toLowerCase();
      const selectedKecamatan = document.getElementById("kecamatanFilter").value.toLowerCase();

      filteredData = fullData.filter(row => {
        const matchesSearch = row.some(cell => cell.toString().toLowerCase().includes(searchValue));
        const matchesKecamatan = selectedKecamatan === "" || (row[getKecamatanIndex()] || "").toLowerCase() === selectedKecamatan;
        return matchesSearch && matchesKecamatan;
      });

      currentPage = 1;
      renderTable();
      renderPagination();
    }

    function renderFilterOptions() {
      const kecamatanIndex = getKecamatanIndex();
      const kecamatanSet = new Set(fullData.map(row => row[kecamatanIndex]).filter(Boolean));
      const select = document.getElementById("kecamatanFilter");

      Array.from(kecamatanSet).sort().forEach(kec => {
        const option = document.createElement("option");
        option.value = kec;
        option.textContent = kec;
        select.appendChild(option);
      });
    }

    function getKecamatanIndex() {
      return headers.findIndex(h => h.toLowerCase().includes("kecamatan"));
    }

    function openPreviewModalGrid(fileObjs) {
      const container = document.getElementById("previewContentRow");
      container.innerHTML = "";

      fileObjs.forEach(obj => {
        const col = document.createElement("div");
        col.className = "col-md-6";

        col.innerHTML = `
          <div class="border rounded p-2 shadow-sm">
            <h6>${obj.label}</h6>
            <iframe src="https://drive.google.com/file/d/${obj.fileId}/preview" 
                    class="w-100"
                    style="height: 600px; border: none;"></iframe>
          </div>
        `;

        container.appendChild(col);
      });

      const modal = new bootstrap.Modal(document.getElementById("previewModal"));
      modal.show();
    }

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("kecamatanFilter").addEventListener("change", applyFilters);
  </script>

</body>
</html>
